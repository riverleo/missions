<script lang="ts">
	import * as Tabs from '$lib/components/ui/tabs';
	import * as Card from '$lib/components/ui/card';
	import { Progress } from '$lib/components/ui/progress';
	import { Badge } from '$lib/components/ui/badge';
	import IconUser from '@tabler/icons-svelte/icons/user';
	import IconSword from '@tabler/icons-svelte/icons/sword';
	import IconShield from '@tabler/icons-svelte/icons/shield';
	import IconHeart from '@tabler/icons-svelte/icons/heart';
	import IconBolt from '@tabler/icons-svelte/icons/bolt';
	import IconBackpack from '@tabler/icons-svelte/icons/backpack';
	import IconTrophy from '@tabler/icons-svelte/icons/trophy';
	import IconHelmet from '@tabler/icons-svelte/icons/helmet';
	import IconNecklace from '@tabler/icons-svelte/icons/necklace';
	import IconJacket from '@tabler/icons-svelte/icons/jacket';
	import IconGlove from '@tabler/icons-svelte/icons/glove';
	import IconBelt from '@tabler/icons-svelte/icons/belt';
	import IconShirt from '@tabler/icons-svelte/icons/shirt';
	import IconShoe from '@tabler/icons-svelte/icons/shoe';
	import IconCircle from '@tabler/icons-svelte/icons/circle';
	import { dndzone } from 'svelte-dnd-action';

	type Rarity = 'common' | 'rare' | 'epic' | 'legendary';
	type EquipmentSlot =
		| 'helmet'
		| 'amulet'
		| 'armor'
		| 'gloves'
		| 'belt'
		| 'pants'
		| 'boots'
		| 'weapon'
		| 'offhand'
		| 'ring1'
		| 'ring2';

	interface Equipment {
		id: number;
		name: string;
		rarity: Rarity;
		type: EquipmentSlot;
	}

	interface InventoryItem {
		id: number;
		name: string;
		type: string;
		quantity: number;
		rarity: Rarity;
	}

	// TODO: 실제 데이터는 props나 store에서 가져오기
	let playerData = $state({
		name: '용감한 모험가',
		level: 5,
		experience: 350,
		experienceToNextLevel: 500,
		characterClass: '전사',
		stats: {
			hp: { current: 85, max: 100 },
			mp: { current: 30, max: 50 },
			attack: 25,
			defense: 18,
			speed: 12,
		},
		equipment: {
			helmet: { id: 101, name: '강철 투구', rarity: 'rare', type: 'helmet' } as Equipment | null,
			amulet: null as Equipment | null,
			armor: { id: 102, name: '가죽 갑옷', rarity: 'common', type: 'armor' } as Equipment | null,
			gloves: { id: 103, name: '가죽 장갑', rarity: 'common', type: 'gloves' } as Equipment | null,
			belt: null as Equipment | null,
			pants: null as Equipment | null,
			boots: { id: 104, name: '무쇠 부츠', rarity: 'rare', type: 'boots' } as Equipment | null,
			weapon: { id: 105, name: '강철 검', rarity: 'rare', type: 'weapon' } as Equipment | null,
			offhand: null as Equipment | null,
			ring1: null as Equipment | null,
			ring2: null as Equipment | null,
		},
		inventory: [
			{ id: 1, name: '체력 물약', type: 'consumable', quantity: 3, rarity: 'common' },
			{ id: 2, name: '마나 물약', type: 'consumable', quantity: 5, rarity: 'common' },
			{ id: 3, name: '경험치 부스터', type: 'consumable', quantity: 1, rarity: 'rare' },
			{ id: 10, name: '미스릴 검', type: 'weapon', quantity: 1, rarity: 'epic' },
			{ id: 11, name: '드래곤 갑옷', type: 'armor', quantity: 1, rarity: 'legendary' },
			{ id: 12, name: '마법의 투구', type: 'helmet', quantity: 1, rarity: 'epic' },
			{ id: 13, name: '악마의 목걸이', type: 'amulet', quantity: 1, rarity: 'legendary' },
			{ id: 14, name: '용의 장갑', type: 'gloves', quantity: 1, rarity: 'rare' },
			{ id: 15, name: '전사의 벨트', type: 'belt', quantity: 1, rarity: 'rare' },
			{ id: 16, name: '미스릴 바지', type: 'pants', quantity: 1, rarity: 'epic' },
			{ id: 17, name: '질풍의 부츠', type: 'boots', quantity: 1, rarity: 'epic' },
			{ id: 18, name: '수호자의 방패', type: 'offhand', quantity: 1, rarity: 'rare' },
			{ id: 19, name: '생명의 반지', type: 'ring1', quantity: 1, rarity: 'epic' },
			{ id: 20, name: '힘의 반지', type: 'ring2', quantity: 1, rarity: 'rare' },
		] as InventoryItem[],
	});

	const rarityColors: Record<Rarity, string> = {
		common: 'bg-gray-500',
		rare: 'bg-blue-500',
		epic: 'bg-purple-500',
		legendary: 'bg-orange-500',
	};

	let draggedItem = $state<InventoryItem | Equipment | null>(null);
	let dragSource = $state<'inventory' | EquipmentSlot | null>(null);

	function getSlotIcon(slot: EquipmentSlot) {
		const iconMap = {
			helmet: IconHelmet,
			amulet: IconNecklace,
			armor: IconJacket,
			gloves: IconGlove,
			belt: IconBelt,
			pants: IconShirt,
			boots: IconShoe,
			weapon: IconSword,
			offhand: IconShield,
			ring1: IconCircle,
			ring2: IconCircle,
		};
		return iconMap[slot];
	}

	function getSlotLabel(slot: EquipmentSlot) {
		const labelMap = {
			helmet: '투구',
			amulet: '목걸이',
			armor: '갑옷',
			gloves: '장갑',
			belt: '벨트',
			pants: '바지',
			boots: '부츠',
			weapon: '무기',
			offhand: '방패',
			ring1: '반지1',
			ring2: '반지2',
		};
		return labelMap[slot];
	}

	function handleDragStart(item: InventoryItem | Equipment, source: 'inventory' | EquipmentSlot) {
		draggedItem = item;
		dragSource = source;
	}

	function handleDragEnd() {
		draggedItem = null;
		dragSource = null;
	}

	function canEquipItem(item: InventoryItem | Equipment, slot: EquipmentSlot): boolean {
		return item.type === slot;
	}

	function handleEquipmentDrop(slot: EquipmentSlot) {
		if (!draggedItem || !dragSource) return;

		// Check if the item can be equipped in this slot
		if (!canEquipItem(draggedItem, slot)) {
			handleDragEnd();
			return;
		}

		if (dragSource === 'inventory') {
			// Moving from inventory to equipment
			const item = draggedItem as InventoryItem;
			const currentEquipped = playerData.equipment[slot];

			// Create equipment item from inventory item
			const newEquipment: Equipment = {
				id: item.id,
				name: item.name,
				rarity: item.rarity,
				type: slot,
			};

			// Equip the new item
			playerData.equipment[slot] = newEquipment;

			// Remove from inventory or decrease quantity
			const inventoryIndex = playerData.inventory.findIndex((i) => i.id === item.id);
			if (inventoryIndex !== -1) {
				if (playerData.inventory[inventoryIndex].quantity > 1) {
					playerData.inventory[inventoryIndex].quantity--;
				} else {
					playerData.inventory.splice(inventoryIndex, 1);
				}
			}

			// If there was an item equipped, add it back to inventory
			if (currentEquipped) {
				const existingInventoryItem = playerData.inventory.find(
					(i) => i.id === currentEquipped.id
				);
				if (existingInventoryItem) {
					existingInventoryItem.quantity++;
				} else {
					playerData.inventory.push({
						id: currentEquipped.id,
						name: currentEquipped.name,
						type: currentEquipped.type,
						quantity: 1,
						rarity: currentEquipped.rarity,
					});
				}
			}
		} else if (dragSource !== slot) {
			// Swapping between equipment slots
			const sourceItem = draggedItem as Equipment;
			const targetItem = playerData.equipment[slot];

			// Swap the items
			playerData.equipment[slot] = sourceItem;
			playerData.equipment[dragSource] = targetItem as Equipment | null;
		}

		handleDragEnd();
	}

	function handleInventoryDrop() {
		if (!draggedItem || !dragSource || dragSource === 'inventory') {
			handleDragEnd();
			return;
		}

		// Moving from equipment to inventory
		const equippedItem = draggedItem as Equipment;
		const slot = dragSource as EquipmentSlot;

		// Add to inventory
		const existingInventoryItem = playerData.inventory.find((i) => i.id === equippedItem.id);
		if (existingInventoryItem) {
			existingInventoryItem.quantity++;
		} else {
			playerData.inventory.push({
				id: equippedItem.id,
				name: equippedItem.name,
				type: equippedItem.type,
				quantity: 1,
				rarity: equippedItem.rarity,
			});
		}

		// Remove from equipment
		// @ts-ignore - equipment slot accepts null
		playerData.equipment[slot] = null;

		handleDragEnd();
	}
</script>

<Card.Root class="w-full">
	<Card.Header>
		<div class="flex items-start justify-between">
			<div class="flex items-center gap-4">
				<div
					class="flex size-16 items-center justify-center rounded-full bg-gradient-to-br from-primary/20 to-primary/5"
				>
					<IconUser class="size-10 text-primary" />
				</div>
				<div>
					<Card.Title>{playerData.name}</Card.Title>
					<Card.Description>
						{playerData.characterClass} • Lv.{playerData.level}
					</Card.Description>
				</div>
			</div>
			<Badge variant="secondary" class="gap-1">
				<IconTrophy class="size-3" />
				{playerData.experience} / {playerData.experienceToNextLevel} EXP
			</Badge>
		</div>

		<!-- Experience Bar -->
		<div class="space-y-1">
			<div class="flex justify-between text-xs text-muted-foreground">
				<span>경험치</span>
				<span>{Math.round((playerData.experience / playerData.experienceToNextLevel) * 100)}%</span>
			</div>
			<Progress value={(playerData.experience / playerData.experienceToNextLevel) * 100} />
		</div>
	</Card.Header>

	<Card.Content>
		<Tabs.Root value="status" class="w-full">
			<Tabs.List class="grid w-full grid-cols-3">
				<Tabs.Trigger value="status">스테이터스</Tabs.Trigger>
				<Tabs.Trigger value="equipment">장비</Tabs.Trigger>
				<Tabs.Trigger value="inventory">인벤토리</Tabs.Trigger>
			</Tabs.List>

			<!-- Status Tab -->
			<Tabs.Content value="status" class="space-y-4">
				<!-- HP/MP Bars -->
				<div class="space-y-3">
					<div class="space-y-1">
						<div class="flex items-center justify-between text-sm">
							<div class="flex items-center gap-2">
								<IconHeart class="size-4 text-red-500" />
								<span class="font-medium">HP</span>
							</div>
							<span class="text-muted-foreground">
								{playerData.stats.hp.current} / {playerData.stats.hp.max}
							</span>
						</div>
						<Progress
							value={(playerData.stats.hp.current / playerData.stats.hp.max) * 100}
							class="[&>div]:bg-red-500"
						/>
					</div>

					<div class="space-y-1">
						<div class="flex items-center justify-between text-sm">
							<div class="flex items-center gap-2">
								<IconBolt class="size-4 text-blue-500" />
								<span class="font-medium">MP</span>
							</div>
							<span class="text-muted-foreground">
								{playerData.stats.mp.current} / {playerData.stats.mp.max}
							</span>
						</div>
						<Progress
							value={(playerData.stats.mp.current / playerData.stats.mp.max) * 100}
							class="[&>div]:bg-blue-500"
						/>
					</div>
				</div>

				<!-- Stats Grid -->
				<div class="grid grid-cols-3 gap-3">
					<div class="rounded-lg border p-3 text-center">
						<div class="flex items-center justify-center gap-1 text-muted-foreground">
							<IconSword class="size-4" />
						</div>
						<div class="mt-1 text-2xl font-bold">{playerData.stats.attack}</div>
						<div class="text-xs text-muted-foreground">공격력</div>
					</div>
					<div class="rounded-lg border p-3 text-center">
						<div class="flex items-center justify-center gap-1 text-muted-foreground">
							<IconShield class="size-4" />
						</div>
						<div class="mt-1 text-2xl font-bold">{playerData.stats.defense}</div>
						<div class="text-xs text-muted-foreground">방어력</div>
					</div>
					<div class="rounded-lg border p-3 text-center">
						<div class="flex items-center justify-center gap-1 text-muted-foreground">
							<IconBolt class="size-4" />
						</div>
						<div class="mt-1 text-2xl font-bold">{playerData.stats.speed}</div>
						<div class="text-xs text-muted-foreground">속도</div>
					</div>
				</div>
			</Tabs.Content>

			<!-- Equipment Tab -->
			<Tabs.Content value="equipment" class="py-4">
				{#snippet equipmentSlot(slot: EquipmentSlot)}
					{@const equipment = playerData.equipment[slot]}
					{@const SlotIcon = getSlotIcon(slot)}
					<div
						class="relative flex flex-col items-center justify-center rounded-lg border-2 p-2 transition-all min-h-[90px] {draggedItem &&
						canEquipItem(draggedItem, slot)
							? 'border-primary bg-primary/10 shadow-lg'
							: equipment
								? 'border-border bg-accent/30'
								: 'border-dashed border-muted-foreground/30 bg-muted/20'}"
						role="button"
						tabindex="0"
						ondragover={(e) => {
							if (draggedItem && canEquipItem(draggedItem, slot)) {
								e.preventDefault();
							}
						}}
						ondrop={(e) => {
							e.preventDefault();
							handleEquipmentDrop(slot);
						}}
					>
						<div
							class="flex items-center gap-3 {playerData.equipment.weapon ? 'cursor-grab active:cursor-grabbing' : ''}"
							draggable={!!playerData.equipment.weapon}
							ondragstart={() => playerData.equipment.weapon && handleDragStart(playerData.equipment.weapon, 'weapon')}
							ondragend={handleDragEnd}
							role="button"
							tabindex="0"
						>
							<IconSword class="size-5 text-muted-foreground" />
							<div>
								<div class="font-medium">{playerData.equipment.weapon?.name || '장착 안됨'}</div>
								<div class="text-xs text-muted-foreground">무기</div>
							</div>
						</div>
						{#if playerData.equipment.weapon}
							<Badge variant="secondary" class={rarityColors[playerData.equipment.weapon.rarity]}>
								{playerData.equipment.weapon.rarity}
							</Badge>
						{/if}
					</div>

					<!-- Armor Slot -->
					<div
						class="flex items-center justify-between rounded-lg border p-3 transition-colors {draggedItem &&
						canEquipItem(draggedItem, 'armor')
							? 'border-primary/50 bg-primary/5'
							: ''}"
						role="button"
						tabindex="0"
						ondragover={(e) => {
							if (draggedItem && canEquipItem(draggedItem, 'armor')) {
								e.preventDefault();
							}
						}}
						ondrop={(e) => {
							e.preventDefault();
							handleEquipmentDrop('armor');
						}}
					>
						<div
							class="flex items-center gap-3 {playerData.equipment.armor ? 'cursor-grab active:cursor-grabbing' : ''}"
							draggable={!!playerData.equipment.armor}
							ondragstart={() => playerData.equipment.armor && handleDragStart(playerData.equipment.armor, 'armor')}
							ondragend={handleDragEnd}
							role="button"
							tabindex="0"
						>
							<IconShield class="size-5 text-muted-foreground" />
							<div>
								<div class="font-medium">{playerData.equipment.armor?.name || '장착 안됨'}</div>
								<div class="text-xs text-muted-foreground">방어구</div>
							</div>
						</div>
						{#if playerData.equipment.armor}
							<Badge variant="secondary" class={rarityColors[playerData.equipment.armor.rarity]}>
								{playerData.equipment.armor.rarity}
							</Badge>
						{/if}
					</div>

					<!-- Accessory Slot -->
					<div
						class="flex items-center justify-between rounded-lg border p-3 transition-colors {draggedItem &&
						canEquipItem(draggedItem, 'accessory')
							? 'border-primary/50 bg-primary/5'
							: ''}"
						role="button"
						tabindex="0"
						ondragover={(e) => {
							if (draggedItem && canEquipItem(draggedItem, 'accessory')) {
								e.preventDefault();
							}
						}}
						ondrop={(e) => {
							e.preventDefault();
							handleEquipmentDrop('accessory');
						}}
					>
						<div
							class="flex items-center gap-3 {playerData.equipment.accessory ? 'cursor-grab active:cursor-grabbing' : ''}"
							draggable={!!playerData.equipment.accessory}
							ondragstart={() => playerData.equipment.accessory && handleDragStart(playerData.equipment.accessory, 'accessory')}
							ondragend={handleDragEnd}
							role="button"
							tabindex="0"
						>
							<IconBackpack class="size-5 text-muted-foreground" />
							<div>
								<div class="font-medium">
									{playerData.equipment.accessory?.name || '장착 안됨'}
								</div>
								<div class="text-xs text-muted-foreground">장신구</div>
							</div>
						</div>
						{#if playerData.equipment.accessory}
							<Badge variant="secondary" class={rarityColors[playerData.equipment.accessory.rarity]}>
								{playerData.equipment.accessory.rarity}
							</Badge>
						{/if}
					</div>
				</div>
			</Tabs.Content>

			<!-- Inventory Tab -->
			<Tabs.Content value="inventory" class="space-y-3">
				<div
					class="space-y-2 min-h-[200px] rounded-lg border-2 border-dashed p-2 transition-colors {draggedItem &&
					dragSource !== 'inventory'
						? 'border-primary/50 bg-primary/5'
						: 'border-transparent'}"
					ondragover={(e) => {
						if (draggedItem && dragSource !== 'inventory') {
							e.preventDefault();
						}
					}}
					ondrop={(e) => {
						e.preventDefault();
						handleInventoryDrop();
					}}
					role="region"
					aria-label="인벤토리"
				>
					{#each playerData.inventory as item (item.id)}
						<div
							class="flex items-center justify-between rounded-lg border p-3 hover:bg-accent/50 cursor-grab active:cursor-grabbing transition-opacity {draggedItem?.id === item.id ? 'opacity-50' : ''}"
							draggable="true"
							ondragstart={() => handleDragStart(item, 'inventory')}
							ondragend={handleDragEnd}
							role="button"
							tabindex="0"
						>
							<div class="flex items-center gap-3">
								<div
									class="flex size-10 items-center justify-center rounded-md {rarityColors[
										item.rarity
									]}"
								>
									<IconBackpack class="size-5 text-white" />
								</div>
								<div>
									<div class="font-medium">{item.name}</div>
									<div class="text-xs text-muted-foreground">{item.type}</div>
								</div>
							</div>
							<div class="text-sm font-semibold">×{item.quantity}</div>
						</div>
					{/each}
					{#if playerData.inventory.length === 0}
						<div class="flex items-center justify-center h-[180px] text-muted-foreground">
							인벤토리가 비어있습니다
						</div>
					{/if}
				</div>
			</Tabs.Content>
		</Tabs.Root>
	</Card.Content>
</Card.Root>
